<div id="gerent-data-dining-item-edit-list">
    <div class="listbox table-responsive" style="margin-bottom: 0; margin-top: 3px;">
        <table class="table table-hover table-striped">
            <thead>
                <tr>
                    <th data-fn="name" class="form-ignored">名称</th>
                    <th data-fn="price" style="width:5em;" class="form-ignored text-right">单价</th>
                    <th data-fn="count" style="width:5em;" class="form-ignored text-right">数量</th>
                    <th data-fn="admin" style="width:2em;"></th>
                </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
                <tr>
                    <th>总价,总数:</th>
                    <th class="total text-right"></th>
                    <th class="count text-right" style="padding-right: 0.95em;"></th>
                    <th>
                        <span class="append glyphicon glyphicon-plus" style="cursor: pointer;"></span>
                    </th>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
<script type="text/javascript">
    (function($) {
        var context = $("#gerent-data-dining-item-edit-list").removeAttr("id");
        var formbox = context.closest("form");
        var nameInp = formbox.find(".bill-name");
        var costInp = formbox.find("[name=total],[name=price],[name=worth]");
        var unitTn  = H$("#unit", context) || "food";
        var unitFn  = unitTn !== "food" ? unitTn + "_id" : "unit_id";
        var unitId  = H$(  "#" + unitFn , context  );

        var listobj = context.hsList({
            _url: "gerent/data/dining/"+unitTn+"/item/search.act?md=6&rn=0&"+unitFn+"="+unitId
        });
        listobj.fillPage = function() {};
        listobj.fillList = function(lst, forSel) {
            this._total = 0;
            this._count = 0;
            this._names = [];
            HsList.prototype.fillList.call(this,lst);
            context.find(".total").text(this._total);
            context.find(".count").text(this._count);
            
            // 选完或价格没填则自动填充
            if (! costInp.val()) {
                costInp.val(this._total);
            } else if ( forSel ) {
                costInp.val(this._total);
                $.hsNote("价格已更新, 请留意!");
            }
            
            // 名称为所有菜名串联到一起
            if (nameInp.size( )) {
                nameInp.val(this._names.join(", "));
            }
        };
        listobj._fill_name  = function() {
            return this._info.name
                || this._info.food.name ;
        };
        listobj._fill_price = function() {
            return this._info.price
                || this._info.food.price;
        };
        listobj._fill_count = function(td) {
            var fid   = this._info.food.id   ;
            var name  = this._info.food.name ;
            var price = this._info.food.price;
            var count = this._info.count || 1;
            var worth = unitTn != "food" ? price : "";
            td.append($('<input type="hidden"/>').val( fid ).attr({
                name: "items."+fid+".food_id"
            }));
            td.append($('<input type="hidden"/>').val(worth).attr({
                name: "items."+fid+".price"
            }));
            td.append($('<input type="number"/>').val(count).attr({
                name: "items."+fid+".count",
                setp: "1",
                min : "1",
                max : "999999"
            } ).css({
                "text-align": "right",
                "height" : "37px",
                "border" : "0"
            })).css({
                "padding": "0"
            });
            td.closest("tr").data({
                food_id: fid,
                price: price,
                count: count,
                name : name
            });
            this._names.push(name);
            this._count += parseFloat(count);
            this._total += parseFloat(count)
                        *  parseFloat(price);
        };
        listobj._fill_admin = function(td) {
            td.append($('<span class="remove glyphicon glyphicon-trash" style="cursor: pointer;"></span>'));
        };
        if (unitId) {
            listobj.load();
        }

        var params = "";
        if (unitTn == "food") {
            params = "?boost!ge=0&type!ne=套餐&id!ne="+unitId;
        }
        context.on("click", ".remove", function() {
            $(this).closest("tr").remove();
        });
        context.on("click", ".append", function() {
            var box = $('<div></div>').attr({
                "data-fn": "items.",
                "data-tk": "name",
                "data-vk": "id"
            });
            $(this).hsFork(
                "gerent/data/dining/food/list_fork.html"+params,
                context.hsFind("@"),
                box,
                function(box , val) {
                    var list = [];
                    for(var id in val) {
                        var arr = val[id];
                        var txt = arr[0 ];
                        var inf = arr[1 ];
                        list.push({
                            food_id: id ,
                            food: {
                                 id: id ,
                               name: txt,
                              price: inf.price
                            },
                              price: "" ,
                              count: 1
                        });
                    }
                    listobj.fillList(list, true);
                    listobj.fillPage({});
                },
                function(box , val) {
                    context.find("tbody tr").each(function() {
                        var fid  = $(this).data("food_id");
                        var name = $(this).data("name");
                        var info = $(this).data();
                        val[fid] = [ name, info ];
                    });
                }
            );
        });
        context.on("change", "input[type=number],.total,.count", function() {
            var th = $(this).closest("table").find("tfoot th");
            var tr = $(this).closest("tr" );
            var rawPrice = tr.data("price");
            var oldCount = tr.data("count");
            var newCount = parseFloat( $(this).val() );
            var countAll = parseFloat(th.eq(2).text()) - oldCount + newCount;
            var priceAll = parseFloat(th.eq(1).text()) - oldCount * rawPrice + newCount * rawPrice;
            tr.data("count", newCount);
            th.eq( 2 ).text( countAll);
            th.eq( 1 ).text( priceAll);

            // 修改实际售价
            costInp.val(priceAll);
            $.hsNote("价格已更新, 请留意!");
        });
    })(jQuery);
</script>
