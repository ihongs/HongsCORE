<h2>{DO}用户</h2>
<div id="master-user-form"
     data-module="hsForm"
     data-load-url="centra/master/user/info.act?ab=!enum&amp;navi-conf=default"
     data-save-url="centra/master/user/save.act"
     data-data-0="_fill_head: (hsFormFillView) ">
    <form action="" method="POST" enctype="multipart/form-data" autocomplete="off">
        <input type="hidden" name="id"/>
        <input type="hidden" name="depts..dept_id" class="form-ignored"/>
        <div style="height: 0; overflow: hidden;">
            <input type="text"     name="_u"/>
            <input type="password" name="_s"/>
        </div>
        <div class="row">
            <div class="col-xs-6">
                <div class="form-group">
                    <label class="control-label">账号</label>
                    <input type="text" name="username" class="form-control" required="required" data-unique="centra/master/user/unique.act?id=${id}" autocomplete="off"/>
                </div>
                <div class="form-group">
                    <label class="control-label">口令</label>
                    <input type="password" name="password" class="form-control" required="required" data-relate="passcode" data-error="请重复输入口令" placeholder="请重复输入口令" autocomplete="off"/>
                </div>
                <div class="form-group">
                    <input type="password" name="passcode" class="form-control" required="required" data-repeat="password" data-error="请重复输入口令" placeholder="请重复输入口令" autocomplete="off"/>
                </div>
                <div class="form-group">
                    <label class="control-label">昵称</label>
                    <input type="text"  name="name"  class="form-control" required="required"/>
                </div>
                <div class="form-group">
                    <label class="control-label">手机</label>
                    <input type="tel"   name="phone" class="form-control"/>
                </div>
                <div class="form-group">
                    <label class="control-label">邮箱</label>
                    <input type="email" name="email" class="form-control"/>
                </div>
                <div class="form-group dont-close">
                    <label class="control-label">头像</label>
                    <input type="text" name="head" class="invisible form-ignored"/>
                    <input type="file" name="head" class="invisible form-ignored" accept="image/*"/>
                    <ul class="pickbox" data-fn="head" data-size="150*150"></ul>
                    <button type="button" class="btn btn-default form-control" data-toggle="hsView">请选择头像</button>
                    <p class="help-block">缩略图比例 1:1, 推荐分辨率 150*150 到 300*300 (像素)</p>
                </div>
                <div class="form-group">
                    <label class="control-label">备注</label>
                    <textarea name="note" class="form-control"></textarea>
                </div>
            </div>
            <div class="col-xs-6">
                <div class="form-group checkset" data-item-class="col-xs-6 col-lg-3"
                     data-fn="roles..role" data-ft="_checkset"
                     data-vl="roles"   data-tl="text"
                     data-vk="name"    data-tk="text">
                    <h4>权限设置</h4>
                </div>
                <div class="form-group checkbox" data-item-class="col-xs-6 col-lg-3"
                     data-fn="depts..dept_id" data-ft="_check"
                     data-vk="dept_id" data-tk="name">
                    <h4>分组设置</h4>
                </div>
            </div>
        </div>
        <div class="form-group">
            <button type="submit" class="commit btn btn-primary">提交</button>
            <button type="button" class="cancel btn btn-link"   >取消</button>
        </div>
    </form>
</div>
<script type="text/javascript">
    (function($) {
        var context = $("#master-user-form");

        context.on("loadBack", function(ev, rd) {
            var dp = H$("@dept_id", context);
            if (rd["info"]) {
                rd["enum"]["depts..dept_id"] = rd["info"]["depts"];
                $(this).find("[name=password],[name=passcode]").removeAttr("required"); // 修改时密码为选填
                $(this).find("[name='depts..dept_id']").val ( "" );
            } else {
                $(this).find("[name='depts..dept_id']").val ( dp );
                $(this).find('[data-fn="depts..dept_id"]').hide( );
            }
        });

        // 选择与之关联的权限
        context.on("change", "[name='roles..role']", function() {
            var area = $(this).closest(".form-group");
            if ($(this).prop("checked")) {
                var rels = $(this).data("rels");
                if (rels) {
                    for(var i = 0 ; i < rels.length ; i ++) {
                        var r = rels[i];
                        area.find("[value='"+r+"']:not(:checked)")
                            .prop("checked", true).change();
                    }
                }
            } else {
                var r = $(this).val();
                area.find(":checked:not(.checkall)" ).not(this)
                    .each(function( ) {
                    var rels = $(this).data( "rels" );
                    if (rels && $.inArray( r, rels  ) !== -1  ) {
                        $(this).prop("checked",false).change( );
                    }
                });
            }
        });
    })(jQuery);
</script>