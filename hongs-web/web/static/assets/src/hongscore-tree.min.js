function HsTree(c,i){c=jQuery(c);var j=c.closest(".loadbox");var l=c.find(".treebox");var s=c.find(".findbox");var g=hsGetValue(i,"loadUrl");var d=hsGetValue(i,"sendUrls");var v=hsGetValue(i,"openUrls");var e=hsGetValue(i,"linkUrls");var a=hsGetValue(i,"loadData");this.idKey=hsGetValue(i,"idKey","id");this.pidKey=hsGetValue(i,"pidKey","pid");this.nameKey=hsGetValue(i,"nameKey","name");this.noteKey=hsGetValue(i,"noteKey");this.typeKey=hsGetValue(i,"typeKey");this.cnumKey=hsGetValue(i,"cnumKey");var b={id:hsGetValue(i,"rootId",hsGetConf("tree.root.id","0")),name:hsGetValue(i,"rootName",hsGetLang("tree.root.name")),note:hsGetValue(i,"rootNote",hsGetLang("tree.root.note")),type:"__ROOT__"};this.context=c;this.loadBox=j;this.treeBox=l;this._pid="";this._url="";this._data=[];if(i){for(var r in i){if("_"===r.substring(0,1)||this[r]!==undefined){this[r]=i[r]}}}var f=this;var q,p,h;function t(x){var B=jQuery(this);var k=x.data[1];var y=x.data[2];var A=B.closest(".tooltip");if(A.length){B=A.data("trigger")}if(typeof(y)==="function"){y.call(f,B,k);return}var w;if(-1!=jQuery.inArray(l[0],B.parents())){w=f.getCid(B)}else{w=f.getSid()}if(w==null){return}var z={};z[f.idKey]=w;y=hsFixPms(y,j);f.send(B,k,y,z)}if(d){jQuery.each(d,function(m,k){switch(k.length){case 3:h=k[0];p=k[1];q=k[2];break;case 2:h=k[0];p=k[1];q=undefined;break;default:return}if(typeof(p)!=="string"||/^[@%\^\-+~>*#]/.test(p)){c.hsFind(p).on("click",[p,q,h],t)}else{c.on("click",p,[p,q,h],t)}})}function o(x){var B=jQuery(this);var k=x.data[1];var y=x.data[2];var A=B.closest(".tooltip");if(A.length){B=A.data("trigger")}if(typeof(y)==="function"){y.call(f,B,k);return}var w;if(-1!=jQuery.inArray(l[0],B.parents())){w=f.getCid(B)}else{w=f.getSid()}if(w==null){return}var z={};z[f.idKey]=w;y=hsFixPms(y,j);f.open(B,k,y,z)}if(v){jQuery.each(v,function(m,k){switch(k.length){case 3:h=k[0];p=k[1];q=k[2];break;case 2:h=k[0];p=k[1];q=undefined;break;default:return}if(typeof(p)!=="string"||/^[@%\^\-+~>*#]/.test(p)){c.hsFind(p).on("click",[p,q,h],o)}else{c.on("click",p,[p,q,h],o)}})}l.on("click",".tree-node td.tree-name",function(){f.select(jQuery(this).closest(".tree-node"))});l.on("click",".tree-node td.tree-hand",function(){f.toggle(jQuery(this).closest(".tree-node"))});l.on("dblclick",".tree-node td:not(.tree-hand)",function(){f.toggle(jQuery(this).closest(".tree-node"))});if(e){l.on("treeSelect",function(x,y){for(var w=0;w<e.length;w++){var n=e[w][0];var k=e[w][1];n=n.replace("{ID}",encodeURIComponent(y));n=hsFixPms(n,j);l.hsFind(k).hsLoad(n)}})}this.fillInfo(b,jQuery("<div/>").appendTo(l).attr("id","tree-node-"+b.id).attr("class","tree-node tree-root"));if(g){this.load(b.id,hsFixPms(g,j),hsSerialMix(a,s))}}HsTree.prototype={load:function(a,b,c){c=hsSerialObj(c);if(a){this._pid=a}if(b){this._url=b}if(c){this._data=c}hsSetSeria(this._data,this.pidKey,this._pid);this.ajax({url:this._url,data:this._data,type:"POST",dataType:"json",funcName:"load",cache:false,global:false,context:this,complete:function(d){this.loadBack(d,a)}})},loadBack:function(d,b){d=hsResponse(d);if(d.ok===false){return}d._pid=b;this.treeBox.trigger("loadBack",[d,this]);this.fillList(d.list||[],b);this.treeBox.trigger("loadOver",[d,this]);var a=this.getSid();var c=this.getRid();if(this.treeBox.find("#tree-node-"+a).size()===0){if(this.treeBox.find("#tree-node-"+b).size()===0){this.select(c)}else{this.select(b)}}},fillList:function(g,f){var d,j,c,a;j=this.treeBox.find("#tree-node-"+f);d=j.children(".tree-list:first");if(g.length==0){j.removeClass("tree-fold").removeClass("tree-open");d.remove();return}j.addClass("tree-open");if(d.length==0){d=jQuery('<div class="tree-list"></div>');d.appendTo(j)}var h,b,e={};e[f]=d;for(c=g.length-1;c>-1;c--){a=hsGetValue(g[c],this.idKey);j=this.treeBox.find("#tree-node-"+a);if(j.length==0){j=jQuery('<div class="tree-node"></div>');j.attr("id","tree-node-"+a)}else{j.find("table:first").empty();h=this.getPid(j);b=j.closest(".tree-list");if(h!=f){e[h]=b}}j.prependTo(d);this.fillInfo(g[c],j)}for(c in e){this.fillCnum(g.length,e[c])}},fillInfo:function(d,a){var c=jQuery('<table><tbody><tr><td class="tree-hand"><span class="caret"></span></td><td class="tree-name"></td><td class="tree-cnum"></td></tr></tbody></table>');var e,b;e=hsGetValue(d,this.nameKey);c.find(".tree-name").text(e);if(typeof(this.noteKey)!=="undefined"){e=hsGetValue(d,this.noteKey);a.find(".tree-name").attr("title",e)}if(typeof(this.typeKey)!=="undefined"){b=hsGetValue(d,this.typeKey);a.addClass("tree-type-"+b)}if(typeof(this.cnumKey)!=="undefined"){e=hsGetValue(d,this.cnumKey);c.find(".tree-cnum").text(e);if(e){a.addClass("tree-fold")}}else{a.addClass("tree-fold")}c.prependTo(a)},fillCnum:function(d,c){var b=c.closest(".tree-node");var a=c.children(".tree-node");if(typeof(d)==="undefined"){d=a.length}if(d!=a.length){for(var e=a.length-1;e>d-1;e--){jQuery(a[e]).remove()}}if(d!=0){b.find(".tree-cnum").text(d.toString())}else{b.find(".tree-cnum").hide();b.removeClass("tree-fold").removeClass("tree-open")}},send:function(b,f,a,e){var d=this;var c=function(){var g=jQuery.extend({},hsSerialDat(a),hsSerialDat(e||{}));d.ajax({url:a,data:e,type:"POST",dataType:"json",funcName:"send",cache:false,global:false,context:d,trigger:b,complete:function(h){this.sendBack(b,h,g)}})};if(!f){c()}else{this.warn(f,"warning",c,null)}},sendBack:function(b,d,c){d=hsResponse(d,1);if(d.ok){if(d.msg){this.note(d.msg,"success")}}else{if(d.msg){this.warn(d.msg,"warning")}else{this.warn(hsGetLang("error.unkwn"))}return}var a=jQuery.Event("sendBack");b.trigger(a,[d,c,this]);if(a.isDefaultPrevented()){return}if(c[this.pidKey]!==undefined){this.load(c[this.pidKey])}if(c[this.idKey]!==undefined){this.load(this.getPid(c[this.idKey]))}},open:function(c,g,b,d){if(-1!=b.indexOf("{ID}")){var e,j,a=[];j=hsSerialArr(d);for(e=0;e<j.length;e++){a.push(encodeURIComponent(j[e].value))}b=b.replace("{ID}",a.join(","));d=undefined}var h=this;var f=jQuery.extend({},hsSerialDat(b),hsSerialDat(d||{}));if(g){if(g instanceof String&&/^_/.test(g)){b=hsSetPms(b,d);window.open(b,g);return}g=c.hsFind(g);g.hsOpen(b,d,function(){h.openBack(c,jQuery(this),f)}).data("rel",c.closest(".loadbox").get(0))}else{jQuery.hsOpen(b,d,function(){h.openBack(c,jQuery(this),f)})}},openBack:function(a,c,d){var b=this;a.trigger("openBack",[c,d,this]);c.on("saveBack",function(f,h,e){var g=jQuery.Event("saveBack");g.relatedTarget=f.target;g.relatedHsInst=e;a.trigger(g,[h,d,b]);if(g.isDefaultPrevented()){return}if(d[b.pidKey]!==undefined){b.load(d[b.pidKey])}else{if(d[b.idKey]!==undefined){b.load(b.getPid(d[b.idKey]))}else{b.load(b.getSid())}}})},ajax:function(){return jQuery.hsAjax.apply(window,arguments)},note:function(){return jQuery.hsNote.apply(window,arguments)},warn:function(){return jQuery.hsWarn.apply(window,arguments)},select:function(c){var a=this.getNode(c);c=this.getId(a);var b=jQuery.Event("treeSelect");a.children("table").trigger(b,[c,this]);if(b.isDefaultPrevented()){return}this.treeBox.find(".tree-curr").removeClass("tree-curr");a.addClass("tree-curr")},toggle:function(d){var b=this.getNode(d);d=this.getId(b);var c=jQuery.Event("treeToggle");b.children("table").trigger(c,[d,this]);if(c.isDefaultPrevented()){return}var a=b.children(".tree-list");a.toggle();if(a.size()){b.removeClass("tree-open").removeClass("tree-fold");a.is(":visible")?b.addClass("tree-open"):b.addClass("tree-fold")}else{this.load(d)}},getId:function(a){if(typeof(a)==="object"){return this.getId(a.attr("id"))}else{if(a){return a.toString().substring(10)}else{return""}}},getPid:function(a){return this.getId(this.getPnode(a))},getCid:function(a){return this.getId(a.closest(".tree-node"))},getSid:function(){return this.getId(this.treeBox.find(".tree-curr"))},getRid:function(){return this.getId(this.treeBox.find(".tree-root"))},getNode:function(a){if(typeof(a)==="object"){return a.closest(".tree-node")}else{return this.treeBox.find("#tree-node-"+a)}},getPnode:function(a){return this.getNode(a).parent().closest(".tree-node")}};jQuery.fn.hsTree=function(a){return this.hsBind(HsTree,a)};(function(a){a(document).on("treeSelect",".HsTree .tree-node>table",function(b,f,e){var d=e.context;var c=e.getRid();d.find(".for-select").prop("disabled",c==f)}).on("selectstart",".HsTree",function(b){b.preventDefault()})})(jQuery);