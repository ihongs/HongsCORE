<h2>新建文件</h2>
<div id="global-file-file-modify"
     data-module="hsForm"
     data-save-url="manage/file/update.act">
    <form action="" method="POST">
        <input type="hidden" name="type" data-pn="txt" />
        <input type="hidden" name="path" data-pn="path"/>
        <input type="hidden" name="dist" data-pn="path"/>
        <div class="row">
            <div class="col-md-6 center-block">
                <div class="form-group">
                    <label class="control-label">文件名</label>
                    <input type="text" name="name" class="form-control" required="required"/>
                </div>
                <div class="form-group">
                    <label class="control-label">内容</label>
                    <textarea name="text" class="form-control"></textarea>
                </div>
                <div>
                    <button type="submit" class="ensure btn btn-primary">创建</button>
                    <button type="button" class="cancel btn btn-link"   >取消</button>
                </div>
            </div>
        </div>
    </form>
</div>
<link rel="stylesheet" href="static/addons/codemirror/codemirror.css">
<script src="static/addons/codemirror/codemirror.js"></script>
<script type="text/javascript">
    (function($) {
        var context = $("#global-file-file-modify").removeAttr("id");

        context.data("_fill_dist", function() {
            return this._info.path.replace(/\/[^\/]*$/, '');
        });
        
        context.data("_fill_text", function(inp, val) {
            inp.val(val);
            var cm = CodeMirror.fromTextArea(inp[0], {
                mode: this._info.mime,
                lineNumbers: true
            });
            inp.data("CM", cm);
        });

        context.find("form").on("submit", function(evt) {
            var inst = context.data("HsForm");
            var form = $(this);
            var data = {
                dist : form.find("[name=dist]").val() + "/" + form.find("[name=name]").val(),
                path : form.find("[name=path]").val(),
                text : form.find("[name=text]").val(),
                type : "file"
            };
            evt.preventDefault();
            if (!inst.validate()) {
                return false;
            }
            jQuery.hsAjax({
                "url"       : form.attr("action"),
                "data"      : data,
                "type"      : "POST",
                "dataType"  : "json",
                "funcName"  : "save",
                "async"     : false,
                "cache"     : false,
                "global"    : false,
                "context"   : inst,
                "complete"  : inst.saveBack,
                "error"     : function() { return false; }
            });
        });
    })(jQuery);
</script>